\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerthemeSaintPetersburg}[2016/06/12 Saint Petersburg State University unofficial beamer theme]

\mode<presentation>

% font theme
\RequirePackage{FiraMono}
\RequirePackage[default]{opensans}
\RequirePackage{ifxetex}
\ifxetex%
\RequirePackage{fontspec}
\defaultfontfeatures{Mapping=tex-text}
\setmainfont[
	Extension=.ttf,
	UprightFont=*-Regular,
	BoldFont=*-Bold,
	ItalicFont=*-Italic,
	BoldItalicFont=*-BoldItalic
]{OpenSans}
\setromanfont[
	Extension=.otf,
	UprightFont=*-Regular,
	BoldFont=*-Bold,
	ItalicFont=*-Italic,
]{OldStandard}
\setsansfont[
	Extension=.ttf,
	UprightFont=*-Regular,
	BoldFont=*-Bold,
	ItalicFont=*-Italic,
	BoldItalicFont=*-BoldItalic
]{OpenSans}
\setmonofont[
	Extension=.otf,
	UprightFont=*-Regular,
	BoldFont=*-Bold
]{FiraMono}
\newfontfamily\cyrillicfont[
	Extension=.ttf,
	UprightFont=*-Regular,
	BoldFont=*-Bold,
	ItalicFont=*-Italic,
	BoldItalicFont=*-BoldItalic
]{OpenSans}
\newfontfamily\cyrillicfontrm[
	Extension=.otf,
	UprightFont=*-Regular,
	BoldFont=*-Bold,
	ItalicFont=*-Italic,
]{OldStandard}
\newfontfamily\cyrillicfontsf[
	Extension=.ttf,
	UprightFont=*-Regular,
	BoldFont=*-Bold,
	ItalicFont=*-Italic,
	BoldItalicFont=*-BoldItalic
]{OpenSans}
\newfontfamily\cyrillicfonttt[
	Extension=.otf,
	UprightFont=*-Regular,
	BoldFont=*-Bold
]{FiraMono}
\newfontfamily\rmfamily[
	Extension=.otf,
	UprightFont=*-Regular,
	BoldFont=*-Bold,
	ItalicFont=*-Italic,
]{OldStandard}
\newfontfamily\sffamily[
	Extension=.ttf,
	UprightFont=*-Regular,
	BoldFont=*-Bold,
	ItalicFont=*-Italic,
	BoldItalicFont=*-BoldItalic
]{OpenSans}
\newfontfamily\ttfamily[
	Extension=.otf,
	UprightFont=*-Regular,
	BoldFont=*-Bold
]{FiraMono}
\fi%

\renewcommand*\familydefault{\sfdefault}

\setbeamerfont{note page}{size=\small}
\setbeamerfont{tiny structure}{family=\sffamily}
\setbeamerfont{structure}{family=\sffamily}
\setbeamerfont{section in toc}{family=\sffamily}
\setbeamerfont{subsection in toc}{family=\sffamily}
\setbeamerfont{subsubsection in toc}{family=\sffamily}
\setbeamerfont{block title alerted}{series=\bfseries}
\usefonttheme{professionalfonts}

% inner theme
\RequirePackage{graphicx}
\RequirePackage{tikz}
\makeatletter%
\usebackgroundtemplate{%
	\ifnum\thepage=1\relax%
		\hspace{\beamer@leftmargin}%
		\begin{beamercolorbox}[wd=\paperwidth,ht=\paperheight,dp=0pt]{background canvas}%
			\begin{tikzpicture}[remember picture,overlay]
				% top left CoA
				\node[anchor=north west] at (current page.north west) {%
					\hspace*{-2mm}%
					\iflanguage{russian}{%
						\includegraphics[height=0.2\paperheight]{spbu-block-ru}%
					}{%
						\includegraphics[height=0.2\paperheight]{spbu-block-en}%
					}%
				};
				% background CoA
				\node[anchor=south east,opacity=0.1] at (current page.south east) {%
					\includegraphics[width=0.7\paperwidth,trim=0 55 10 0,clip]{spbu-CoA}%
				};
			\end{tikzpicture}
    	\end{beamercolorbox}
	\else%
		\usebeamercolor[bg]{background canvas}\rule{\paperwidth}{\paperheight}%
	\fi%
} 
\makeatother%

% insert a field using theme colors and font
\newcommand*{\spbuInsertField}[1]{%
\usebeamerfont{#1}%
\usebeamercolor[fg]{#1}%
\expandafter\relax\csname insert#1\endcsname%
\par%
}

\setbeamertemplate{title page}{%
	\centering
	\vspace{0.2\textheight}\spbuInsertField{title}%
	\vfill\spbuInsertField{author}
	\vfill\spbuInsertField{institute}
	\vfill\ifx\insertsubtitle\empty\else%
		\spbuInsertField{subtitle}
	\fi
	\inserttitlegraphic
	\vfill\spbuInsertField{date}
}

% horizontal bar colors
\definecolor{spbuBar1}{HTML}{aa1d21}
\definecolor{spbuBar2}{HTML}{93a5a7}
\definecolor{spbuBar3}{HTML}{051014}
\definecolor{spbuBar4}{HTML}{93a5a7}
\definecolor{spbuBar5}{HTML}{aa1d21}
\definecolor{spbuBar6}{HTML}{93a5a7}

\setbeamertemplate{frametitle}{%
	\spbuInsertField{frametitle}
	\ifx\insertframesubtitle\empty\else%
		\spbuInsertField{framesubtitle}
	\fi%
%	\begin{tikzpicture}[x=\paperwidth,y=1mm]
%		\fill[spbuBar1] (0.000,0) rectangle(0.305,1);
%		\fill[spbuBar2] (0.305,0) rectangle(0.327,1);
%		\fill[spbuBar3] (0.327,0) rectangle(0.419,1);
%		\fill[spbuBar4] (0.419,0) rectangle(0.513,1);
%		\fill[spbuBar5] (0.513,0) rectangle(0.565,1);
%		\fill[spbuBar6] (0.565,0) rectangle(1.000,1);
%	\end{tikzpicture}
}

\setbeamertemplate{navigation symbols}{}
\beamertemplatenavigationsymbolsempty

% black-on-white speaker notes
\setbeamertemplate{note page}{%
	% TODO fix textwidth
	\begin{minipage}{0.85\paperwidth}%
		\spbuInsertField{note}%
	\end{minipage}%
}

% block
\setbeamertemplate{block begin}{
	\vspace{-\baselineskip}%
	\begin{flushright}
		\begin{beamercolorbox}[colsep*=.75ex]{block title}%
			\usebeamerfont*{block title}\insertblocktitle
		\end{beamercolorbox}%
		{\parskip0pt\nointerlineskip\par}%
		\usebeamerfont{block body}%
		\begin{beamercolorbox}[colsep*=.75ex,vmode]{block body}%
}
\setbeamertemplate{block end}{
		\end{beamercolorbox}
	\end{flushright}
}

% alterblock
\setbeamertemplate{block alerted begin}{
	\vspace{-\baselineskip}%
	\begin{flushright}
		\begin{beamercolorbox}[colsep*=.75ex]{block title alerted}%
			\usebeamerfont*{block title alerted}\insertblocktitle
		\end{beamercolorbox}%
		{\parskip0pt\nointerlineskip\par}%
		\usebeamerfont{block body alerted}%
		\begin{beamercolorbox}[colsep*=.75ex,vmode]{block body alerted}%
}
\setbeamertemplate{block alerted end}{
		\end{beamercolorbox}
	\end{flushright}
}

% exampleblock
\setbeamertemplate{block example begin}{
	\vspace{-\baselineskip}%
	\begin{flushright}
		\begin{beamercolorbox}[colsep*=.75ex]{block title example}%
			\usebeamerfont*{block title example}\insertblocktitle
		\end{beamercolorbox}%
		{\parskip0pt\nointerlineskip\par}%
		\usebeamerfont{block body example}%
		\begin{beamercolorbox}[colsep*=.75ex,vmode]{block body example}%
}
\setbeamertemplate{block example end}{
		\end{beamercolorbox}
	\end{flushright}
}

% QED
\setbeamertemplate{qed symbol}{$\blacksquare$}

% theorem/corollary etc.
\setbeamertemplate{theorem begin}{%
	\normalfont% ignore body font
	\begin{\inserttheoremblockenv}{%
		\inserttheoremname
		\ifx\inserttheoremaddition\empty\else\ (\inserttheoremaddition)\fi%
	}
	\sffamily%
}
\setbeamertemplate{theorem end}{\end{\inserttheoremblockenv}}

% color theme

% corporate colors
\definecolor{spbuTerracotta}{cmyk}{.08,.91,.92,.33}
\definecolor{spbuGray}{cmyk}{.21,.11,.09,.22}

\definecolor{spbuWhite1}{RGB}{245,246,245}
\definecolor{spbuWhite2}{RGB}{230,231,230}
\definecolor{spbuWhite3}{RGB}{217,218,217}

\definecolor{spbuWhiteRed2}{RGB}{255,231,230}
\definecolor{spbuWhiteRed3}{RGB}{255,160,160}
\definecolor{spbuRed}{RGB}{200,40,40}

\definecolor{spbuDarkGray}{HTML}{5F7177}
\definecolor{spbuTerracottaLight}{HTML}{9F827F}
\definecolor{spbuTerracottaDark}{HTML}{CC7066}

\setbeamercolor{normal text}{fg=spbuDarkGray,bg=spbuWhite1}
\setbeamercolor{frametitle}{bg=spbuWhite1,fg=spbuTerracotta}
\setbeamercolor{title}{bg=spbuWhite1,fg=spbuTerracotta}
\setbeamercolor{subtitle}{parent=normal text}
\setbeamercolor{date}{parent=normal text}
\setbeamercolor{author}{parent=normal text}
\setbeamercolor{background canvas}{parent=normal text}
\setbeamercolor{background}{parent=background canvas}
\setbeamercolor{math text}{fg=spbuDarkGray,bg=spbuWhite1}
\setbeamercolor{item}{parent=normal text}
\setbeamercolor{block title}{fg=spbuDarkGray,bg=spbuWhite3}
\setbeamercolor{block body}{fg=spbuDarkGray,bg=spbuWhite2}
\setbeamercolor{block title alerted}{fg=spbuRed,bg=spbuWhiteRed3}
\setbeamercolor{block body alerted}{fg=spbuDarkGray,bg=spbuWhiteRed2}
\setbeamercolor{block title example}{bg=spbuWhite3}
\setbeamercolor{block body example}{fg=spbuDarkGray,bg=spbuWhite2}

% part, section, subsection pages, table of contents page
\setbeamercolor{section in toc}{parent=normal text}
\setbeamercolor{part page}{parent=frametitle}
\setbeamercolor{section page}{parent=frametitle}
\setbeamercolor{subsection page}{parent=frametitle}
\setbeamercolor{part title}{parent=frametitle,fg=spbuDarkGray}

% provide string translations to Russian
\newtranslation[to=russian]{Part}{Часть}
\newtranslation[to=russian]{Section}{Раздел}
\newtranslation[to=russian]{Subsection}{Подраздел}

\mode<all>
